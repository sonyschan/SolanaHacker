<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Memeya Agent Dashboard</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #c9d1d9;
    --text-dim: #8b949e;
    --cyan: #58a6ff;
    --purple: #bc8cff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --pink: #f778ba;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    padding: 20px;
    max-width: 1100px;
    margin: 0 auto;
  }
  h1 {
    font-size: 1.6em;
    color: var(--pink);
    border-bottom: 1px solid var(--border);
    padding-bottom: 12px;
    margin-bottom: 20px;
  }
  h1 span { color: var(--purple); }
  .meta { color: var(--text-dim); font-size: 0.85em; margin-bottom: 24px; }
  .meta code { background: var(--surface); padding: 2px 6px; border-radius: 3px; color: var(--cyan); }

  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .section-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    cursor: pointer;
    user-select: none;
    gap: 8px;
  }
  .section-header:hover { background: rgba(88,166,255,0.06); }
  .section-header .icon { font-size: 1.1em; }
  .section-header h2 {
    font-size: 1em;
    font-weight: 600;
    color: var(--text);
    flex: 1;
  }
  .section-header .badge {
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 10px;
    background: rgba(247,120,186,0.15);
    color: var(--pink);
  }
  .chevron {
    color: var(--text-dim);
    transition: transform 0.2s;
    font-size: 0.8em;
  }
  .section.collapsed .chevron { transform: rotate(-90deg); }
  .section.collapsed .section-body { display: none; }
  .section-body { padding: 0 16px 16px; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85em;
  }
  th {
    text-align: left;
    color: var(--text-dim);
    font-weight: 600;
    padding: 6px 10px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  td {
    padding: 6px 10px;
    border-bottom: 1px solid rgba(48,54,61,0.5);
    vertical-align: top;
  }
  tr:last-child td { border-bottom: none; }
  td code {
    background: rgba(88,166,255,0.08);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 0.92em;
    color: var(--cyan);
  }

  .tag {
    display: inline-block;
    font-size: 0.75em;
    padding: 1px 7px;
    border-radius: 10px;
    margin: 1px 2px;
    white-space: nowrap;
  }
  .tag-cyan { background: rgba(88,166,255,0.15); color: var(--cyan); }
  .tag-purple { background: rgba(188,140,255,0.15); color: var(--purple); }
  .tag-green { background: rgba(63,185,80,0.15); color: var(--green); }
  .tag-orange { background: rgba(210,153,34,0.15); color: var(--orange); }
  .tag-pink { background: rgba(247,120,186,0.15); color: var(--pink); }

  pre.prompt-block {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    font-size: 0.82em;
    line-height: 1.6;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text);
    margin-top: 12px;
    max-height: 400px;
    overflow-y: auto;
  }

  .journal-day {
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 8px;
    overflow: hidden;
  }
  .journal-day-header {
    padding: 8px 12px;
    background: rgba(48,54,61,0.3);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    color: var(--cyan);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .journal-day-header:hover { background: rgba(88,166,255,0.06); }
  .journal-day-body {
    padding: 10px 12px;
    font-size: 0.85em;
    white-space: pre-wrap;
    line-height: 1.6;
  }
  .journal-day.collapsed .journal-day-body { display: none; }

  .timeline {
    position: relative;
    padding-left: 20px;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 6px;
    top: 4px;
    bottom: 4px;
    width: 2px;
    background: var(--border);
  }
  .timeline-item {
    position: relative;
    margin-bottom: 12px;
    font-size: 0.85em;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -18px;
    top: 6px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid var(--pink);
    background: var(--bg);
  }
  .timeline-item.posted::before { border-color: var(--green); background: var(--green); }
  .timeline-time {
    color: var(--text-dim);
    font-size: 0.9em;
    font-weight: 600;
  }
  .timeline-desc { color: var(--text); margin-top: 2px; }
  .timeline-tweet {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    margin-top: 4px;
    font-size: 0.92em;
    color: var(--text);
    word-break: break-word;
    white-space: pre-wrap;
  }
  .timeline-tweet a { color: var(--cyan); text-decoration: none; }
  .timeline-tweet a:hover { text-decoration: underline; }

  .note {
    font-size: 0.8em;
    color: var(--text-dim);
    margin-top: 8px;
    padding: 8px 10px;
    background: rgba(48,54,61,0.3);
    border-radius: 4px;
    border-left: 3px solid var(--border);
  }

  .placeholder {
    color: var(--text-dim);
    font-style: italic;
    padding: 16px;
    text-align: center;
    font-size: 0.9em;
  }

  .status-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    margin-bottom: 16px;
    font-size: 0.85em;
  }
  .status-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--text-dim);
    flex-shrink: 0;
  }
  .status-dot.alive { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.dead { background: var(--red); box-shadow: 0 0 6px var(--red); }

  .analyze-btn {
    padding: 8px 20px;
    border-radius: 6px;
    border: 1px solid var(--pink);
    background: rgba(247,120,186,0.12);
    color: var(--pink);
    cursor: pointer;
    font-size: 0.95em;
    font-family: inherit;
    font-weight: 600;
    transition: all 0.2s;
  }
  .analyze-btn:hover:not(:disabled) { background: rgba(247,120,186,0.25); }
  .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .reboot-btn {
    padding: 4px 12px;
    border-radius: 5px;
    border: 1px solid var(--orange);
    background: rgba(210,153,34,0.12);
    color: var(--orange);
    cursor: pointer;
    font-size: 0.82em;
    font-family: inherit;
    font-weight: 600;
    transition: all 0.2s;
  }
  .reboot-btn:hover:not(:disabled) { background: rgba(210,153,34,0.3); }
  .reboot-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .analysis-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-top: 12px;
    font-size: 0.88em;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    display: none;
  }
  .analysis-card.visible { display: block; }
  .analysis-card h3 { color: var(--pink); margin-bottom: 8px; font-size: 1em; }

  .spinner {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--pink);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-text { color: var(--red); font-size: 0.85em; }
  .loading-text { color: var(--text-dim); font-size: 0.85em; margin: 8px 0; }

  .nav-link {
    color: var(--cyan);
    text-decoration: none;
    font-size: 0.85em;
  }
  .nav-link:hover { text-decoration: underline; }

  /* Pipeline flow styles */
  .pipe-step {
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 10px;
    overflow: hidden;
  }
  .pipe-step-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(48,54,61,0.3);
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 600;
  }
  .pipe-step-header:hover { background: rgba(88,166,255,0.06); }
  .pipe-step-num {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px; height: 22px;
    border-radius: 50%;
    font-size: 0.75em;
    font-weight: 700;
    flex-shrink: 0;
  }
  .pipe-step-num.ok { background: rgba(63,185,80,0.2); color: var(--green); }
  .pipe-step-num.warn { background: rgba(210,153,34,0.2); color: var(--orange); }
  .pipe-step-num.fail { background: rgba(248,81,73,0.2); color: var(--red); }
  .pipe-step-title { flex: 1; color: var(--text); }
  .pipe-step-badge {
    font-size: 0.75em;
    padding: 1px 7px;
    border-radius: 10px;
    white-space: nowrap;
  }
  .pipe-step.collapsed .pipe-step-body { display: none; }
  .pipe-step-body {
    padding: 10px 12px;
    font-size: 0.82em;
    line-height: 1.7;
  }
  .pipe-step-body .kv { display: flex; gap: 6px; margin-bottom: 3px; }
  .pipe-step-body .kv .k { color: var(--text-dim); min-width: 120px; flex-shrink: 0; }
  .pipe-step-body .kv .v { color: var(--text); word-break: break-word; }
  .pipe-step-body .kv .v.ok { color: var(--green); }
  .pipe-step-body .kv .v.warn { color: var(--orange); }
  .pipe-step-body .kv .v.fail { color: var(--red); }
  .pipe-weight-bar {
    display: inline-block;
    height: 8px;
    border-radius: 4px;
    margin-right: 4px;
    vertical-align: middle;
  }
  .pipe-final-tweet {
    background: var(--bg);
    border: 2px solid var(--green);
    border-radius: 8px;
    padding: 12px 14px;
    font-size: 0.95em;
    line-height: 1.5;
    color: var(--text);
    word-break: break-word;
    white-space: pre-wrap;
  }
  .pipe-final-tweet.bored { border-color: var(--orange); }

  /* Toggle switch */
  .toggle-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85em;
  }
  .toggle {
    position: relative;
    width: 40px; height: 22px;
    border-radius: 11px;
    background: var(--border);
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .toggle.on { background: var(--green); }
  .toggle::after {
    content: '';
    position: absolute;
    top: 2px; left: 2px;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: #fff;
    transition: left 0.2s;
  }
  .toggle.on::after { left: 20px; }

  @media (max-width: 700px) {
    body { padding: 12px; }
    table { font-size: 0.8em; }
    td, th { padding: 4px 6px; }
  }
</style>
</head>
<body>

<div class="status-bar" id="status-bar">
  <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
    <span class="status-dot" id="status-dot"></span>
    <span id="status-text">Checking...</span>
    <code id="status-uptime" style="font-size:0.85em;color:var(--text-dim);"></code>
  </div>
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="toggle-wrap">
      <span style="color:var(--text-dim);">Heartbeat X Post:</span>
      <div class="toggle" id="xpost-toggle" onclick="toggleXPost()"></div>
      <span id="xpost-label" style="font-weight:600;">...</span>
    </div>
    <button class="reboot-btn" id="reboot-btn" onclick="rebootServer()">Reboot Server</button>
    <a href="/dashboard.html" class="nav-link">Agent Dashboard &rarr;</a>
  </div>
</div>

<h1>Memeya <span>Agent Dashboard</span></h1>
<div class="meta">
  @AiMemeForgeIO &middot; Model: <code>grok-4-1-fast-reasoning</code> + <code>grok-3-mini</code> (quality gate) &middot; Character: <code>13yo Digital Blacksmith</code> &middot; Platform: <code>X (Twitter)</code>
</div>

<!-- Section 0: Heartbeat Actions -->
<div class="section" id="s-heartbeat">
  <div class="section-header" onclick="toggle('s-heartbeat')">
    <span class="icon">&#128147;</span>
    <h2>Heartbeat Actions</h2>
    <span class="badge">Schedule</span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="section-body">
    <h3 style="font-size:0.9em;color:var(--pink);margin-bottom:8px;">Autonomous X Posting (maybePostToX)</h3>
    <div style="font-size:0.85em;color:var(--text-dim);margin-bottom:10px;">
      Every <strong style="color:var(--text);">2&ndash;4 hours</strong> (random) &mdash; runs 24/7, no active window.
      Kill switch: <code>.memeya-x-enabled</code> flag file.
    </div>
    <div style="font-size:0.85em;color:var(--text-dim);margin-bottom:10px;">
      Flow: <code>gatherContext()</code> &rarr; <code>chooseTopic()</code> (weighted random) &rarr; <code>generateTweet()</code> via Grok &rarr; boring check &rarr; post to X
    </div>
    <table>
      <tr><th>Topic</th><th>Weight</th><th>Description</th></tr>
      <tr>
        <td><code>meme_spotlight</code></td>
        <td><span class="tag tag-pink">30%</span></td>
        <td>Share/react to a meme from AiMemeForge (today or throwback). Appends OG link.</td>
      </tr>
      <tr>
        <td><code>personal_vibe</code></td>
        <td><span class="tag tag-purple">25%</span></td>
        <td>Raw personal thought, mood, or inner monologue from journal + values.</td>
      </tr>
      <tr>
        <td><code style="color:var(--green);">x_commentary</code></td>
        <td><span class="tag tag-green">20%</span></td>
        <td>Find a crypto KOL post on X &rarr; post Memeya's take (with @mention) + short 2-8 word reply on their tweet.</td>
      </tr>
      <tr>
        <td><code>feature_showtime</code></td>
        <td><span class="tag tag-cyan">15%</span></td>
        <td>Show off an AiMemeForge feature from product.md. Appends site link.</td>
      </tr>
      <tr>
        <td><code>dev_update</code></td>
        <td><span class="tag tag-orange">10%</span></td>
        <td>Share recent git commits as builder updates. Priority-forced if fresh commits + not posted today.</td>
      </tr>
      <tr>
        <td><code style="color:var(--text-dim);">crypto_commentary</code></td>
        <td><span class="tag" style="background:rgba(139,148,158,0.15);color:var(--text-dim);">fallback</span></td>
        <td style="color:var(--text-dim);">Hot take on crypto news via Grok web search. Only triggered as fallback when <code>x_commentary</code> has no KOL post.</td>
      </tr>
      <tr>
        <td><code>community_response</code></td>
        <td><span class="tag tag-purple">dynamic</span></td>
        <td>Reply to community feedback on recent posts. Added dynamically when comments found (weight 20&ndash;35).</td>
      </tr>
    </table>
    <div style="font-size:0.82em;color:var(--text-dim);margin-top:10px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border);">
      <strong style="color:var(--text);">Safeguards:</strong>
      Anti-repetition (last 3 posts can't all be same topic) &middot;
      Boring check via <code>grok-3-mini</code> gates all posts (skipped for <code>meme_spotlight</code> with unique OG and <code>x_commentary</code> replies) &middot;
      Data-availability fallbacks (e.g. <code>x_commentary</code> &rarr; <code>crypto_commentary</code> if no KOL post found)
    </div>
  </div>
</div>

<!-- Section 1: System Prompt -->
<div class="section" id="s-prompt">
  <div class="section-header" onclick="toggle('s-prompt')">
    <span class="icon">&#128203;</span>
    <h2>System Prompt Composition</h2>
    <span class="badge">System</span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="section-body">
    <div id="prompt-loading" class="loading-text"><span class="spinner"></span>Loading prompt data...</div>
    <div id="prompt-content" style="display:none;">
      <table>
        <tr><th>Source</th><th>File</th><th>Limit</th><th>Preview</th></tr>
        <tr>
          <td><code>MEMEYA_PROMPT</code></td>
          <td style="color:var(--text-dim);font-size:0.9em;">skills/x_twitter/index.js</td>
          <td><span class="tag tag-green">Full</span></td>
          <td id="prompt-main-preview" style="font-size:0.85em;max-width:400px;"></td>
        </tr>
        <tr>
          <td><code>values snippet</code></td>
          <td style="color:var(--text-dim);font-size:0.9em;">memory/knowledge/memeya_values.md</td>
          <td><span class="tag tag-orange">300 chars</span></td>
          <td id="prompt-values-preview" style="font-size:0.85em;max-width:400px;"></td>
        </tr>
        <tr>
          <td><code>journal snippet</code></td>
          <td style="color:var(--text-dim);font-size:0.9em;">memory/journal/memeya/*.md (last 2 days)</td>
          <td><span class="tag tag-orange">500 chars</span></td>
          <td id="prompt-journal-preview" style="font-size:0.85em;max-width:400px;"></td>
        </tr>
      </table>
      <h3 style="font-size:0.9em;color:var(--pink);margin:16px 0 4px;">Composed System Prompt (what Grok receives)</h3>
      <pre class="prompt-block" id="composed-system"></pre>
      <h3 style="font-size:0.9em;color:var(--purple);margin:16px 0 4px;">Composed User Prompt (per tweet)</h3>
      <pre class="prompt-block" id="composed-user"></pre>
    </div>
    <div id="prompt-error" class="error-text" style="display:none;"></div>
  </div>
</div>

<!-- Section 2: Current Values -->
<div class="section" id="s-values">
  <div class="section-header" onclick="toggle('s-values')">
    <span class="icon">&#128161;</span>
    <h2>Memeya Values</h2>
    <span class="badge">Info</span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="section-body">
    <div id="values-loading" class="loading-text"><span class="spinner"></span>Loading values...</div>
    <div id="values-content" style="display:none;"></div>
    <div id="values-error" class="error-text" style="display:none;"></div>
  </div>
</div>

<!-- Section 4: Today's Activity -->
<div class="section" id="s-activity">
  <div class="section-header" onclick="toggle('s-activity')">
    <span class="icon">&#128197;</span>
    <h2>Today's Activity</h2>
    <span class="badge" id="activity-badge">Info</span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="section-body">
    <div id="activity-loading" class="loading-text"><span class="spinner"></span>Loading activity...</div>
    <div id="activity-content" style="display:none;"></div>
    <div id="activity-error" class="error-text" style="display:none;"></div>
  </div>
</div>

<!-- Section 5: Generate Post -->
<div class="section" id="s-testgen">
  <div class="section-header" onclick="toggle('s-testgen')">
    <span class="icon">&#9889;</span>
    <h2>Generate Post</h2>
    <span class="badge" style="background:rgba(63,185,80,0.2);color:var(--green);">Function</span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="section-body">
    <p style="font-size:0.85em;color:var(--text-dim);margin-bottom:12px;">
      Generate a tweet using the full pipeline. Optionally specify a purpose for manual content. Click Send to post.
    </p>
    <div style="margin-bottom:12px;">
      <label style="font-size:0.82em;color:var(--text-dim);display:block;margin-bottom:4px;">Purpose <span style="color:var(--purple);">(optional)</span> — overrides auto topic, no char limit:</label>
      <textarea id="purpose-input" rows="2" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:8px 10px;font-family:inherit;font-size:0.88em;resize:vertical;" placeholder="e.g. Announce the new voting feature on AiMemeForge"></textarea>
    </div>
    <button class="analyze-btn" id="testgen-btn" onclick="runTestGenerate()" style="border-color:var(--green);color:var(--green);background:rgba(63,185,80,0.12);">Generate</button>
    <span id="testgen-status" style="margin-left:8px;font-size:0.85em;"></span>
    <div id="testgen-result" style="display:none;margin-top:16px;"></div>
  </div>
</div>

<!-- Section 6: Grok Analysis -->
<div class="section" id="s-analyze">
  <div class="section-header" onclick="toggle('s-analyze')">
    <span class="icon">&#129302;</span>
    <h2>Grok Strategy Analysis</h2>
    <span class="badge" style="background:rgba(247,120,186,0.2);">Function</span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="section-body">
    <p style="font-size:0.85em;color:var(--text-dim);margin-bottom:12px;">
      Send Memeya's recent journals, values, and today's activity to Grok for a strategy analysis and tweet suggestions.
    </p>
    <button class="analyze-btn" id="analyze-btn" onclick="runAnalysis()">Analyze &amp; Suggest</button>
    <span id="analyze-status" style="margin-left:8px;font-size:0.85em;"></span>
    <div class="analysis-card" id="analysis-card">
      <h3>Strategy Analysis</h3>
      <div id="analysis-text"></div>
    </div>
  </div>
</div>

<div class="meta" style="text-align:center;margin-top:24px;padding-top:16px;border-top:1px solid var(--border);">
  <a href="/dashboard.html" class="nav-link">&larr; Back to Agent Dashboard</a>
</div>

<script>
function toggle(id) {
  document.getElementById(id).classList.toggle('collapsed');
}

function toggleJournal(el) {
  el.closest('.journal-day').classList.toggle('collapsed');
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function truncate(s, n) {
  if (!s) return '(empty)';
  return s.length > n ? s.slice(0, n) + '...' : s;
}

// Render journal content with basic formatting
function renderJournalContent(text) {
  return escHtml(text)
    .replace(/^## (.+)$/gm, '<strong style="color:var(--cyan);">$1</strong>')
    .replace(/^- (.+)$/gm, '&bull; $1');
}

// ─── Health check ────────────────────────────────────────────
async function checkHealth() {
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  const uptime = document.getElementById('status-uptime');
  try {
    const res = await fetch('/health', { signal: AbortSignal.timeout(3000) });
    const data = await res.json();
    if (data.ok) {
      dot.className = 'status-dot alive';
      text.textContent = 'Server Online';
      text.style.color = 'var(--green)';
      uptime.textContent = 'uptime: ' + data.uptime;
    }
  } catch {
    dot.className = 'status-dot dead';
    text.textContent = 'Server Offline';
    text.style.color = 'var(--red)';
    uptime.textContent = '';
  }
}
checkHealth();
setInterval(checkHealth, 10000);

// ─── Load prompt data ────────────────────────────────────────
async function loadPrompt() {
  try {
    const res = await fetch('/api/memeya/prompt');
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    document.getElementById('prompt-main-preview').textContent = truncate(data.memeyaPrompt, 80);
    document.getElementById('prompt-values-preview').textContent = data.valuesSnippet ? truncate(data.valuesSnippet, 80) : '(not yet created)';
    document.getElementById('prompt-journal-preview').textContent = data.journalSnippet ? truncate(data.journalSnippet, 80) : '(no journal)';
    document.getElementById('composed-system').textContent = data.composedSystem || '(empty)';
    document.getElementById('composed-user').textContent = data.composedUser || '(empty)';

    document.getElementById('prompt-loading').style.display = 'none';
    document.getElementById('prompt-content').style.display = 'block';
  } catch (err) {
    document.getElementById('prompt-loading').style.display = 'none';
    const el = document.getElementById('prompt-error');
    el.textContent = 'Error loading prompt: ' + err.message;
    el.style.display = 'block';
  }
}

// ─── X Post Toggle ───────────────────────────────────────────
async function loadXPostStatus() {
  try {
    const res = await fetch('/api/memeya/x-post-status');
    const data = await res.json();
    updateXPostUI(data.enabled);
  } catch {
    document.getElementById('xpost-label').textContent = '?';
  }
}

function updateXPostUI(enabled) {
  const toggle = document.getElementById('xpost-toggle');
  const label = document.getElementById('xpost-label');
  if (enabled) {
    toggle.className = 'toggle on';
    label.textContent = 'ON';
    label.style.color = 'var(--green)';
  } else {
    toggle.className = 'toggle';
    label.textContent = 'OFF';
    label.style.color = 'var(--text-dim)';
  }
}

async function toggleXPost() {
  try {
    const res = await fetch('/api/memeya/x-post-toggle', { method: 'POST' });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    updateXPostUI(data.enabled);
  } catch (err) {
    alert('Toggle failed: ' + err.message);
  }
}

// ─── Reboot server ──────────────────────────────────────────
async function rebootServer() {
  if (!confirm('Reboot dashboard server to apply new code changes?')) return;
  const btn = document.getElementById('reboot-btn');
  btn.disabled = true;
  btn.textContent = 'Rebooting...';
  try {
    await fetch('/api/reboot', { method: 'POST' });
  } catch { /* expected — server exits */ }
  // Wait for systemd to restart, then reload page
  let attempts = 0;
  const check = setInterval(async () => {
    attempts++;
    try {
      const res = await fetch('/health');
      if (res.ok) {
        clearInterval(check);
        location.reload();
      }
    } catch { /* still restarting */ }
    if (attempts > 20) {
      clearInterval(check);
      btn.textContent = 'Retry';
      btn.disabled = false;
      alert('Server did not come back after 10s — check systemd status.');
    }
  }, 500);
}

// ─── Load values ─────────────────────────────────────────────
async function loadValues() {
  try {
    const res = await fetch('/api/memeya/values');
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const container = document.getElementById('values-content');
    if (!data.content) {
      container.innerHTML = '<div class="placeholder">No values defined yet. The agent will create <code>memory/knowledge/memeya_values.md</code> when it learns about Memeya\'s preferences.</div>';
    } else {
      container.innerHTML = `<pre class="prompt-block" style="max-height:300px;">${escHtml(data.content)}</pre>`;
    }

    document.getElementById('values-loading').style.display = 'none';
    container.style.display = 'block';
  } catch (err) {
    document.getElementById('values-loading').style.display = 'none';
    const el = document.getElementById('values-error');
    el.textContent = 'Error loading values: ' + err.message;
    el.style.display = 'block';
  }
}

// ─── Load today's activity ───────────────────────────────────
async function loadActivity() {
  try {
    const res = await fetch('/api/memeya/activity');
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const container = document.getElementById('activity-content');
    const badge = document.getElementById('activity-badge');

    if (!data.entries || data.entries.length === 0) {
      container.innerHTML = `<div class="placeholder">No Memeya activity today (${escHtml(data.date)}). Activity is logged when tweets are posted.</div>`;
      badge.textContent = data.date;
    } else {
      badge.textContent = `${data.entries.length} entries`;

      let html = `<div class="note" style="margin-bottom:12px;border-left-color:var(--pink);">Date: ${escHtml(data.date)}</div>`;
      html += '<div class="timeline">';

      for (const entry of data.entries) {
        const isPost = entry.description.includes('Posted:') || entry.description.includes('URL:');
        const lines = entry.description.split('\n').filter(Boolean);

        let descHtml = '';
        let tweetText = '';
        let tweetUrl = '';

        for (const line of lines) {
          const trimmed = line.replace(/^- /, '');
          if (trimmed.startsWith('Posted:')) {
            tweetText = trimmed.replace('Posted: ', '');
          } else if (trimmed.startsWith('URL:')) {
            tweetUrl = trimmed.replace('URL: ', '').trim();
          } else {
            descHtml += escHtml(trimmed) + '<br>';
          }
        }

        html += `<div class="timeline-item${isPost ? ' posted' : ''}">`;
        html += `<div class="timeline-time">${escHtml(entry.time)}</div>`;

        if (tweetText) {
          html += '<div class="timeline-tweet">';
          html += escHtml(tweetText);
          if (tweetUrl) {
            html += `<br><a href="${escHtml(tweetUrl)}" target="_blank" rel="noopener">${escHtml(tweetUrl)}</a>`;
          }
          html += '</div>';
        } else {
          html += `<div class="timeline-desc">${descHtml || escHtml(entry.description)}</div>`;
        }

        html += '</div>';
      }

      html += '</div>';
      container.innerHTML = html;
    }

    document.getElementById('activity-loading').style.display = 'none';
    container.style.display = 'block';
  } catch (err) {
    document.getElementById('activity-loading').style.display = 'none';
    const el = document.getElementById('activity-error');
    el.textContent = 'Error loading activity: ' + err.message;
    el.style.display = 'block';
  }
}

// ─── Test Generate (Pipeline Flow) ───────────────────────────
function togglePipe(el) { el.closest('.pipe-step').classList.toggle('collapsed'); }

function kv(key, val, cls) {
  return `<div class="kv"><span class="k">${escHtml(key)}</span><span class="v${cls ? ' ' + cls : ''}">${val}</span></div>`;
}

function weightBar(topics, chosen) {
  const total = topics.reduce((s, t) => s + t.weight, 0);
  const colors = {
    meme_spotlight: '#3fb950', personal_vibe: '#bc8cff', dev_update: '#58a6ff',
    crypto_commentary: '#d29922', feature_showtime: '#f778ba', community_response: '#f778ba',
  };
  return topics.map(t => {
    const pct = ((t.weight / total) * 100).toFixed(0);
    const c = colors[t.id] || '#8b949e';
    const sel = t.id === chosen ? ' style="outline:2px solid #fff;outline-offset:1px;"' : '';
    return `<span class="pipe-weight-bar" style="width:${Math.max(pct * 1.5, 12)}px;background:${c};"${sel} title="${t.id}: ${t.weight} (${pct}%)"></span><span style="font-size:0.78em;color:${c};margin-right:10px;">${t.id.replace('_', ' ')} ${pct}%${t.id === chosen ? ' ★' : ''}</span>`;
  }).join('');
}

function pipeStep(num, title, badge, badgeCls, bodyHtml, collapsed) {
  return `<div class="pipe-step${collapsed ? ' collapsed' : ''}">
    <div class="pipe-step-header" onclick="togglePipe(this)">
      <span class="pipe-step-num ${badgeCls}">${num}</span>
      <span class="pipe-step-title">${escHtml(title)}</span>
      <span class="pipe-step-badge" style="background:rgba(${badgeCls === 'ok' ? '63,185,80' : badgeCls === 'warn' ? '210,153,34' : '248,81,73'},0.15);color:var(--${badgeCls === 'ok' ? 'green' : badgeCls === 'warn' ? 'orange' : 'red'});">${badge}</span>
      <span class="chevron" style="font-size:0.7em;">&#9660;</span>
    </div>
    <div class="pipe-step-body">${bodyHtml}</div>
  </div>`;
}

// Store last generated post for Send functionality
window._lastGenerated = null;

async function runTestGenerate() {
  const btn = document.getElementById('testgen-btn');
  const status = document.getElementById('testgen-status');
  const result = document.getElementById('testgen-result');
  const purpose = document.getElementById('purpose-input').value.trim();

  btn.disabled = true;
  btn.textContent = 'Generating...';
  status.innerHTML = '<span class="spinner"></span>Running ' + (purpose ? 'purpose-based' : 'full') + ' pipeline...';
  status.style.color = 'var(--text-dim)';
  result.style.display = 'none';
  window._lastGenerated = null;

  try {
    const res = await fetch('/api/memeya/test-generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ purpose }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const f = data.flow || {};
    const ctx = f.context || {};
    const sel = f.topicSelection || {};
    const gen = f.generation || {};
    const gate = f.qualityGate || {};
    const isManual = !!data.purpose;
    let html = '';

    // ── Step 1: Context Gathering ──
    if (isManual) {
      const manualLines = [
        kv('Mode', '<strong style="color:var(--purple);">Manual Purpose</strong>'),
        kv('Purpose', `<span style="color:var(--text);">${escHtml(data.purpose)}</span>`),
        kv('Char limit', '<span style="color:var(--purple);">None (X Premium)</span>'),
      ].join('');
      html += pipeStep('1', 'Context: Manual Purpose', 'manual', 'ok', manualLines, false);
    } else {
      const ctxLines = [
        kv('Today memes', `${ctx.todayMemes || 0} memes`, ctx.todayMemes > 0 ? 'ok' : ''),
        kv('Hall of memes', ctx.randomPastMeme ? `1 random pick: ${escHtml(ctx.randomPastMeme)}` : 'none available'),
        kv('Recent commits', (ctx.commits || []).length > 0
          ? (ctx.commits || []).map(c => `<code style="font-size:0.9em;">${escHtml(c)}</code>`).join('<br>')
          : '<span style="color:var(--text-dim);">none in last 12h</span>'),
        kv('Journal', `${ctx.journalChars || 0} chars`, ctx.journalChars > 0 ? 'ok' : ''),
        kv('Values', `${ctx.valuesChars || 0} chars`, ctx.valuesChars > 0 ? 'ok' : ''),
        kv('Recent posts', `${(ctx.recentPosts || []).length} posts`
          + ((ctx.recentPosts || []).length > 0
            ? '<br>' + (ctx.recentPosts || []).map((p, i) =>
                `<span style="color:var(--text-dim);font-size:0.9em;">${i+1}. ${p.topic ? '<code>' + escHtml(p.topic) + '</code> ' : ''}${escHtml(p.text)}</span>`
              ).join('<br>')
            : '')),
        kv('Comments', ctx.comments > 0 ? `${ctx.comments} posts with ${ctx.commentReplies} replies` : 'no replies found'),
        kv('Product doc', ctx.productDocChars > 0 ? `${ctx.productDocChars} chars (for feature_showtime)` : 'not found'),
      ].join('');
      html += pipeStep('1', 'Context Gathering', `${ctx.todayMemes || 0} memes, ${(ctx.commits||[]).length} commits`, 'ok', ctxLines, false);
    }

    // ── Step 2: Topic Selection ──
    if (isManual) {
      const manualSelLines = [
        kv('Mode', '<span style="color:var(--purple);">Skipped — using manual purpose</span>'),
        kv('Selected', '<strong style="color:var(--purple);">manual_purpose</strong>'),
      ].join('');
      html += pipeStep('2', 'Topic Selection', 'manual_purpose', 'ok', manualSelLines, true);
    } else {
      const pool = sel.pool || [];
      const selLines = [
        kv('Topic pool', pool.length > 0 ? weightBar(pool, data.topic) : '(unknown)'),
        kv('Last 3 topics', (sel.last3Topics || []).length > 0
          ? (sel.last3Topics || []).map(t => `<code>${escHtml(t)}</code>`).join(', ')
          : '<span style="color:var(--text-dim);">(fewer than 3 posts)</span>'),
        sel.priorityForced
          ? kv('Priority', `<strong style="color:var(--cyan);">${escHtml(sel.priorityForced)}</strong> — fresh commits + not posted today`)
          : kv('Priority', '<span style="color:var(--text-dim);">none (normal random)</span>'),
        kv('dev_update today', sel.devUpdateToday ? '<span style="color:var(--orange);">already posted</span>' : '<span style="color:var(--text-dim);">not yet</span>'),
        kv('Anti-repeat', sel.antiRepeatTriggered
          ? '<span style="color:var(--orange);">Triggered — forced different topic</span>'
          : '<span style="color:var(--green);">Not triggered</span>'),
        sel.fallbackFrom
          ? kv('Fallback', `<span style="color:var(--orange);">${escHtml(sel.fallbackFrom)} → personal_vibe (no data)</span>`)
          : '',
        kv('Selected', `<strong style="color:var(--green);">${escHtml(data.topic)}</strong>`),
        data.ogUrl ? kv('OG URL', `<code>${escHtml(data.ogUrl)}</code>`) : '',
      ].join('');
      html += pipeStep('2', 'Topic Selection', data.topic, 'ok', selLines, false);
    }

    // ── Step 3: Prompt Assembly ──
    const charLimitDisplay = data.noCharLimit
      ? '<span style="color:var(--purple);">None (X Premium)</span>'
      : (gen.ogUrl ? `${gen.charLimit} (280 − ${(gen.ogUrl||'').length + 1} for OG link)` : '280');
    const genLines = [
      kv('Model', `<code>${escHtml(gen.model || 'grok-4-1-fast-reasoning')}</code>`),
      kv('Char limit', charLimitDisplay),
      `<details style="margin:6px 0;"><summary style="cursor:pointer;color:var(--cyan);font-size:0.9em;">System prompt (MEMEYA_PROMPT)</summary><pre class="prompt-block" style="margin-top:6px;max-height:200px;">${escHtml(gen.systemPrompt || '(not available)')}</pre></details>`,
      `<details style="margin:6px 0;"><summary style="cursor:pointer;color:var(--purple);font-size:0.9em;">User prompt (assembled)</summary><pre class="prompt-block" style="margin-top:6px;max-height:300px;">${escHtml(gen.userPrompt || data.prompt || '(not available)')}</pre></details>`,
    ].join('');
    html += pipeStep('3', 'Prompt Assembly → Grok', gen.model || 'grok', 'ok', genLines, true);

    // ── Step 4: Generation Output ──
    const rawOut = gen.rawOutput || '';
    const cleanedOut = gen.cleaned || '';
    const beforeGate = gen.finalBeforeGate || '';
    const lenDisplay = data.noCharLimit ? `${beforeGate.length} chars (no limit)` : `${beforeGate.length}/280 chars`;
    const genOutLines = [
      kv('Raw Grok output', `<div class="timeline-tweet" style="margin:4px 0;">${escHtml(rawOut)}</div>`),
      rawOut !== cleanedOut ? kv('After URL strip', `<div class="timeline-tweet" style="margin:4px 0;border-color:var(--cyan);">${escHtml(cleanedOut)}</div>`) : '',
      gen.ogUrl ? kv('OG link appended', `<code>${escHtml(gen.ogUrl)}</code>`) : '',
      kv('Before quality gate', `<div class="timeline-tweet" style="margin:4px 0;">${escHtml(beforeGate)}</div>`),
      kv('Length', lenDisplay),
    ].join('');
    html += pipeStep('4', 'Generation Output', `${beforeGate.length} chars`, 'ok', genOutLines, true);

    // ── Step 5: Quality Gate ──
    const verdictOk = !data.isBored;
    const gateLines = [
      kv('Judge model', '<code>grok-3-mini</code>'),
      kv('Verdict', verdictOk
        ? `<strong style="color:var(--green);">${escHtml(gate.verdict || 'OK')}</strong>`
        : `<strong style="color:var(--red);">${escHtml(gate.verdict || 'BORING')}</strong>`),
      data.isBored ? kv('Original draft', `<div class="timeline-tweet" style="margin:4px 0;border-color:var(--red);opacity:0.7;text-decoration:line-through;">${escHtml(data.originalDraft || '')}</div>`) : '',
      data.isBored ? kv('Bored replacement', `<div class="timeline-tweet" style="margin:4px 0;border-color:var(--orange);">${escHtml(gate.boredReplacement || '')}</div>`) : '',
      `<details style="margin:6px 0;"><summary style="cursor:pointer;color:var(--text-dim);font-size:0.9em;">Quality gate prompt</summary><pre class="prompt-block" style="margin-top:6px;max-height:200px;">${escHtml(gate.checkPrompt || '(not available)')}</pre></details>`,
    ].join('');
    html += pipeStep('5', 'Quality Gate', verdictOk ? 'PASS' : 'BORING → replaced', verdictOk ? 'ok' : 'warn', gateLines, verdictOk);

    // ── Step 6: Final Output + Send Button ──
    const finalTweet = data.draft || '(no output)';
    window._lastGenerated = { text: finalTweet, topic: data.topic };

    const charInfo = data.noCharLimit ? `${finalTweet.length} chars (no limit)` : `${finalTweet.length}/280 chars`;
    const finalHtml = `
      <div class="pipe-final-tweet${data.isBored ? ' bored' : ''}">${escHtml(finalTweet)}</div>
      <div style="display:flex;gap:12px;margin-top:8px;font-size:0.82em;color:var(--text-dim);align-items:center;flex-wrap:wrap;">
        <span>${charInfo}</span>
        ${data.ogUrl ? '<span>OG preview: <code>' + escHtml(data.ogUrl) + '</code></span>' : '<span>No OG link</span>'}
        ${data.isBored ? '<span style="color:var(--orange);">bored vibe — would still be posted</span>' : ''}
      </div>
      <div style="margin-top:14px;display:flex;align-items:center;gap:10px;">
        <button class="analyze-btn" onclick="sendPost()" id="send-btn" style="border-color:var(--cyan);color:var(--cyan);background:rgba(88,166,255,0.12);">Send to X</button>
        <span id="send-status" style="font-size:0.85em;"></span>
      </div>`;
    html += pipeStep('6', 'Final Tweet', data.isBored ? 'bored vibe' : 'ready to send', data.isBored ? 'warn' : 'ok', finalHtml, false);

    result.innerHTML = html;
    result.style.display = 'block';
    status.textContent = data.isBored ? 'Done (bored vibe)' : 'Done';
    status.style.color = data.isBored ? 'var(--orange)' : 'var(--green)';
  } catch (err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = 'var(--red)';
  }

  btn.disabled = false;
  btn.textContent = 'Generate';
}

// ─── Send Post to X ─────────────────────────────────────────
async function sendPost() {
  if (!window._lastGenerated) {
    alert('No generated post to send. Generate one first.');
    return;
  }

  const { text, topic } = window._lastGenerated;
  if (!confirm(`Send this post to @AiMemeForgeIO?\n\n${text.slice(0, 200)}${text.length > 200 ? '...' : ''}`)) return;

  const btn = document.getElementById('send-btn');
  const status = document.getElementById('send-status');

  btn.disabled = true;
  btn.textContent = 'Sending...';
  status.innerHTML = '<span class="spinner"></span>Posting to X...';
  status.style.color = 'var(--text-dim)';

  try {
    const res = await fetch('/api/memeya/send-post', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, topic }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    status.innerHTML = `Posted! <a href="${escHtml(data.url)}" target="_blank" rel="noopener" style="color:var(--cyan);">${escHtml(data.url)}</a>`;
    status.style.color = 'var(--green)';
    btn.textContent = 'Sent';
    window._lastGenerated = null;

    // Refresh activity timeline
    loadActivity();
  } catch (err) {
    status.textContent = 'Send failed: ' + err.message;
    status.style.color = 'var(--red)';
    btn.disabled = false;
    btn.textContent = 'Send to X';
  }
}

// ─── Grok analysis ───────────────────────────────────────────
async function runAnalysis() {
  const btn = document.getElementById('analyze-btn');
  const status = document.getElementById('analyze-status');
  const card = document.getElementById('analysis-card');
  const text = document.getElementById('analysis-text');

  btn.disabled = true;
  btn.textContent = 'Analyzing...';
  status.innerHTML = '<span class="spinner"></span>Calling Grok API...';
  status.style.color = 'var(--text-dim)';
  card.classList.remove('visible');

  try {
    const res = await fetch('/api/memeya/analyze', { method: 'POST' });
    const data = await res.json();

    if (data.error) throw new Error(data.error);

    text.textContent = data.analysis;
    card.classList.add('visible');
    status.textContent = 'Done';
    status.style.color = 'var(--green)';
  } catch (err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = 'var(--red)';
  }

  btn.disabled = false;
  btn.textContent = 'Analyze & Suggest';
}

// ─── Load all data on page load ──────────────────────────────
loadPrompt();
loadValues();
loadActivity();
loadXPostStatus();
</script>
</body>
</html>
